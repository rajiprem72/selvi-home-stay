<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Booking ‚Äî Selvi Home Stay</title>

<link rel="icon" type="image/png" href="https://selvi-home-stay.in/images/favicon.png">
<link rel="stylesheet" href="https://selvi-home-stay.in/style.css">

<style>
  .form-row { display:flex; gap:12px; flex-wrap:wrap; }
  label { display:block; }
  .muted { color:#6b7280; font-size:.92rem; }
  .price { margin:8px 0; font-size:0.95rem; line-height:1.4; }
  .banner img { width:100%; height:auto; display:block; }
  .notice-success {
    margin-top: 20px; padding: 14px 16px; border-radius: 12px;
    background: #ecfdf5; border: 1px solid #a7f3d0; color:#065f46;
  }
  .notice-error {
    margin-top: 20px; padding: 14px 16px; border-radius: 12px;
    background: #fef2f2; border: 1px solid #fecaca; color:#7f1d1d;
  }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }
  .pay-link { margin-top:10px; display:inline-block; font-weight:bold; color:#065f46; }

  .notice-error {
  margin-top:15px;
  padding:12px;
  border-radius:8px;
  background:#fef2f2;
  border:1px solid #fecaca;
  color:#7f1d1d;
}
.notice-success {
  margin-top:15px;
  padding:12px;
  border-radius:8px;
  background:#ecfdf5;
  border:1px solid #a7f3d0;
  color:#065f46;
}
</style>
</head>

<body>
<div id="nav-placeholder"></div>  
<!-- BOOKING WORKFLOW -->
<section style="margin:25px 0;padding:18px;border:1px solid #e5e7eb;
               background:#f9fafb;border-radius:12px;">

  <h3 style="margin-top:0;">üßæ How Booking & Payment Works</h3>

  <ol style="padding-left:20px;line-height:1.7;">
    <li>
      <b>Submit your basic details</b><br>
      <span style="color:#6b7280;">
        Fill in your stay dates, number of members, and contact information.
      </span>
    </li>

    <li>
      <b>Receive payment details by Email</b><br>
      <span style="color:#6b7280;">
        After submission, you will receive a secure payment link from us.
      </span>
    </li>

    <li>
      <b>Make your payment online</b><br>
      <span style="color:#6b7280;">
        You can pay either the advance amount or the full amount using Razorpay.
      </span>
    </li>

    <li>
      <b>Visit Selvi Home Stay on your booking date</b><br>
      <span style="color:#6b7280;">
        Carry your booking confirmation when you arrive.
      </span>
    </li>

    <li>
      <b>Pay the remaining balance (if any)</b><br>
      <span style="color:#6b7280;">
        Balance payment can be completed online or at the property before check-out.
      </span>
    </li>
  </ol>

  <div style="margin-top:12px;font-size:0.92rem;color:#065f46;">
    ‚úÖ Secure payments &nbsp;|&nbsp; ‚úÖ Transparent pricing &nbsp;|&nbsp; ‚úÖ No hidden charges
  </div>
</section>
<!-- https://script.google.com/macros/s/AKfycbxJJUirnar3OBGwszagDNWH_Js0FhYfzKMYyRVl06bH4IOseYcZ3vIRr6izAHERWqko/exec  -->
<div class="container">
  <h2>Booking Form</h2>
<form id="bookingForm"
      method="POST"
      action="https://script.google.com/macros/s/AKfycbxJJUirnar3OBGwszagDNWH_Js0FhYfzKMYyRVl06bH4IOseYcZ3vIRr6izAHERWqko/exec">

<input type="hidden" name="action" value="create_booking">
<input type="hidden" name="Source" value="Website">

<label>Name
  <input type="text" name="Name" required>
</label>

<label>Aadhaar Number
  <input type="text" name="Aadhaar" required>
</label>

<label>Mobile Number
  <input type="text" name="Mobile" required>
</label>

<label>Address
  <textarea name="Address" rows="2" required></textarea>
</label>

<label>From Date
  <input type="date" name="FromDate" required>
</label>

<label>To Date
  <input type="date" name="ToDate" required>
</label>

<label>Members
  <select name="Members" required>
    <option value="">Select</option>
    <option>3</option><option>4</option><option>5</option>
    <option>6</option><option>7</option><option>8</option>
    <option>9</option><option>10</option>
  </select>
</label>

<label>WhatsApp Number
  <input type="text" name="Whatsapp">
</label>

<label>Email
  <input type="email" name="Email">
</label>

<label>Coupon Code
  <input type="text" name="CouponCode" id="CouponCode" placeholder="Optional">
</label>

<label>Message
  <textarea name="Message" rows="3"></textarea>
</label>

<div style="margin:15px 0">
  <label>
    <input type="checkbox" id="rulesAgree" required>
    I agree to the Rules & Regulations
  </label>
</div>

<button type="submit" id="submitBtn">Submit Booking</button>

<div id="formMessage"></div>

</form>
 </div>

<footer>
  ¬© 2025 Selvi Home Stay <br>
  Designed by <br> Premanandhan Narayanan , TN <br>
  WhatsApp +91 98844 86609
</footer>
<script>
/* CONFIG */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxJJUirnar3OBGwszagDNWH_Js0FhYfzKMYyRVl06bH4IOseYcZ3vIRr6izAHERWqko/exec";
const DAYS_WINDOW = 60;

/* HELPERS */
const pad2 = n => (n<10 ? '0'+n : ''+n);
function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function addDays(dt,n){ const x=new Date(dt.getFullYear(),dt.getMonth(),dt.getDate()); x.setDate(x.getDate()+n); return x; }
function parseISO(s){ const [y,m,d] = (s||'').split('-').map(Number); return new Date(y,m-1,d); }

/* STATE */
let RATES = { ratePerDay: 4760, gstPercent: 5, basePerDay: 1000 }; // fallback defaults

/* UI functions */
function showPrice(fromISO, toISO) {
  const el = document.getElementById('priceInfo');
  if (!fromISO || !toISO) { el.innerHTML=''; return; }
  const nights = (parseISO(toISO) - parseISO(fromISO)) / (1000*60*60*24);
  if (nights <= 0) { el.innerHTML=''; return; }

  const perDay = Number(RATES.ratePerDay);
  const gstPct = Number(RATES.gstPercent);
  const basePerDay = Number(RATES.basePerDay);

  const baseTotal = basePerDay * nights;
  const fullSubtotal = perDay * nights;
  const gstAmount = Math.round(fullSubtotal * gstPct / 100);
  const fullTotal = fullSubtotal + gstAmount;

  el.innerHTML = `
    <div><b>Stay:</b> ${nights} night(s)</div>
    <div>Advance: ‚Çπ${basePerDay} √ó ${nights} = <b>‚Çπ${baseTotal}</b></div>
    <div>Full (per day): ‚Çπ${perDay}</div>
    <div>GST @ ${gstPct}% = ‚Çπ${gstAmount}</div>
    <div><b>Total: ‚Çπ${fullTotal}</b></div>
    <a class="pay-link" href="payments.html" target="_blank">‚û° Proceed to Payment</a>
  `;
}

/* Build blocked date set & helpers for options */
function buildBlockedSet(bookings){
  const blocked = new Set();
  bookings.forEach(b => {
    const f = parseISO(b.FromDate); const t = parseISO(b.ToDate);
    if (isNaN(f) || isNaN(t)) return;
    for (let d = new Date(f); d < t; d.setDate(d.getDate()+1)) {
      blocked.add(toISODate(d));
    }
  });
  return blocked;
}
function computeAvailableFromDates(blocked){
  const start = new Date(); start.setHours(0,0,0,0);
  const end = addDays(start, DAYS_WINDOW);
  const out = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
    const iso = toISODate(d);
    if (!blocked.has(iso)) out.push(iso);
  }
  return out;
}
function computeToOptions(fromISO, blockedSorted){
  const today = new Date(); today.setHours(0,0,0,0);
  const windowEnd = addDays(today, DAYS_WINDOW);
  let nextBlocked = null;
  for (const iso of blockedSorted) {
    if (iso > fromISO) { nextBlocked = iso; break; }
  }
  let endBoundary = windowEnd;
  if (nextBlocked) {
    const nb = parseISO(nextBlocked);
    if (nb < endBoundary) endBoundary = nb;
  }
  const arr = [];
  for (let d = addDays(parseISO(fromISO), 1); d <= endBoundary; d.setDate(d.getDate()+1)) {
    arr.push(toISODate(d));
  }
  return arr;
}

/* INIT: load rates and bookings, populate selects */
(async function init(){
  document.getElementById('PaymentDate').value = toISODate(new Date());
  const fromEl = document.getElementById('FromDate');
  const toEl = document.getElementById('ToDate');

  try {
    const r = await fetch(`${APPS_SCRIPT_URL}?action=get_rates`, { cache:'no-store' });
    if (r.ok) {
      const data = await r.json();
      if (data && typeof data.ratePerDay !== 'undefined') RATES = data;
    }
  } catch (err) { console.warn('Could not load rates', err); }

  try {
    const r = await fetch(`${APPS_SCRIPT_URL}?action=get_bookings`, { cache:'no-store' });
    if (!r.ok) throw new Error('Failed fetching bookings');
    const json = await r.json();
    const bookings = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
    const blocked = buildBlockedSet(bookings);
    const blockedSorted = Array.from(blocked).sort();
    const availableFrom = computeAvailableFromDates(blocked);
    if (availableFrom.length === 0) {
      fromEl.innerHTML = '<option value="">No dates available</option>';
      fromEl.disabled = true;
      return;
    }
    fromEl.innerHTML = '<option value="">Select check-in date</option>' +
                       availableFrom.map(d => `<option value="${d}">${d}</option>`).join('');
    fromEl.disabled = false;
    fromEl.addEventListener('change', () => {
      const start = fromEl.value;
      document.getElementById('priceInfo').innerHTML = '';
      if (!start) {
        toEl.innerHTML = '<option value="">Select From Date first</option>';
        toEl.disabled = true;
        return;
      }
      const toOptions = computeToOptions(start, blockedSorted);
      if (toOptions.length === 0) {
        toEl.innerHTML = `<option value="">No valid To Date after ${start}</option>`;
        toEl.disabled = true;
        return;
      }
      toEl.innerHTML = '<option value="">Select checkout date</option>' +
                       toOptions.map(d => `<option value="${d}">${d}</option>`).join('');
      toEl.disabled = false;
      toEl.onchange = () => showPrice(start, toEl.value);
    });
  } catch (err) {
    console.error('Failed to load bookings', err);
    fromEl.innerHTML = '<option value="">Unable to load dates</option>';
    fromEl.disabled = true;
  }
})();

/* ‚úÖ SUBMIT + POPUP HANDLER */
(function setupSubmitPopup() {
  const form = document.getElementById('bookingForm');
  const btn = document.getElementById('submitBtn');
  const confirmationArea = document.getElementById('confirmationArea');
  window._selviPopupRef = null;

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!document.getElementById('rulesAgree').checked) {
      alert('Please agree to the Rules & Regulations before submitting.');
      return;
    }
    const f = form.FromDate?.value, t = form.ToDate?.value;
    if (!f || !t || t <= f) {
      alert('Please choose valid From and To dates.');
      return;
    }
    btn.disabled = true;
    btn.textContent = 'Submitting‚Ä¶';
    const w = 420, h = 460;
    const left = window.screenX + Math.max(0, (window.outerWidth - w) / 2);
    const top = window.screenY + Math.max(0, (window.outerHeight - h) / 2);
    const popup = window.open('', 'SelviPopup', `width=${w},height=${h},top=${top},left=${left},resizable=no,scrollbars=yes`);
    if (!popup) {
      alert('Please allow pop-ups for this website to continue your booking.');
      btn.disabled = false;
      btn.textContent = 'Submit Booking';
      return;
    }
    window._selviPopupRef = popup;
    form.target = 'SelviPopup';
    form.submit();

    // ‚úÖ Detect if popup manually closed
    const popupMonitor = setInterval(() => {
      if (!window._selviPopupRef || window._selviPopupRef.closed) {
        clearInterval(popupMonitor);
        window.location.href = 'index.html';
      }
    }, 1000);

    // ‚úÖ Auto-timeout fallback
    setTimeout(() => {
      if (!window._selviPopupRef || window._selviPopupRef.closed) return;
      try { window._selviPopupRef.close(); } catch (_) {}
      window._selviPopupRef = null;
      window.location.href = 'index.html';
    }, 15000);
  });
})();

/* ‚úÖ SECURE MESSAGE LISTENER */
(function secureMessageListener() {
  const TRUSTED_ORIGINS = new Set(['https://script.google.com']);
  let bookingHandled = false;
  window.addEventListener('message', (event) => {
    try {
      const origin = (event.origin || '').toLowerCase();
      if (!TRUSTED_ORIGINS.has(origin)) return;
    } catch (err) { return; }
    const data = event.data;
    if (bookingHandled) return;
    if (!data || typeof data !== 'object') return;
    if (!('success' in data) || typeof data.success !== 'boolean') return;
    bookingHandled = true;
    const form = document.getElementById('bookingForm');
    const submitBtn = document.getElementById('submitBtn');
    const confirmationArea = document.getElementById('confirmationArea');
    if (data.success) {
      confirmationArea.className = 'notice-success';
      confirmationArea.innerHTML = `
        <div>‚úÖ <b>Booking Confirmed!</b></div>
        <div>Your Booking ID: <b>${data.bookingId || 'N/A'}</b></div>
        <div>We‚Äôll contact you via Phone / WhatsApp / Email.</div>
        <div>This window will close automatically in 15 seconds. Kindly wait.....</div>
       `;
      [...form.elements].forEach(el => el.disabled = true);
      submitBtn.disabled = true;
      if (typeof fbq === 'function') fbq('track','Lead');
    } else {
      confirmationArea.className = 'notice-error';
      confirmationArea.textContent = data.error || '‚ùå Booking failed. Please try again.';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Booking';
    }
    try {
      if (window._selviPopupRef && !window._selviPopupRef.closed) {
        window._selviPopupRef.close();
      }
      window._selviPopupRef = null;
    } catch (_) {}
  }, false);
})();
</script>
<script>
const APPS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbxJJUirnar3OBGwszagDNWH_Js0FhYfzKMYyRVl06bH4IOseYcZ3vIRr6izAHERWqko/exec";

document.getElementById('bookingForm').addEventListener('submit', async function(e){
  e.preventDefault();

  const msgBox = document.getElementById('formMessage');
  msgBox.innerHTML = '';

  if (!document.getElementById('rulesAgree').checked) {
    alert("Please agree to the rules.");
    return;
  }

  const coupon = document.getElementById('CouponCode').value.trim();

  // ‚úÖ Validate coupon ONLY if entered
  if (coupon !== '') {
    try {
      const res = await fetch(
        `${APPS_SCRIPT_URL}?action=validate_coupon&coupon=${encodeURIComponent(coupon)}`,
        { cache:'no-store' }
      );
      const data = await res.json();

      if (!data.valid) {
        msgBox.className = 'notice-error';
        msgBox.innerText = data.message || 'Invalid coupon code';
        return;
      }
    } catch (err) {
      msgBox.className = 'notice-error';
      msgBox.innerText = 'Unable to validate coupon. Please try again.';
      return;
    }
  }

  // ‚úÖ Coupon valid OR not entered ‚Üí submit form
  this.submit();
});
</script>
  
<script src="script.js"></script>
</body>
</html>
