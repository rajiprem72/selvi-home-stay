<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Booking â€” Selvi Home Stay</title>
<link rel="icon" type="image/png" href="images/favicon.png">
<link rel="stylesheet" href="style.css">
<script src="script.js" defer></script>
</head>

<body>
<header>
  <h1>Selvi Home Stay</h1>
  <div class="menu-toggle"><span></span><span></span><span></span></div>
  <nav>
    <a href="index.html">Home</a>
    <a href="gallery.html">Photos</a>
    <a href="videos.html">Videos</a>
    <a href="contact.html">Contact</a>
    <a href="https://script.google.com/macros/s/AKfycbwJdZz6sARjTvWNx-AcBhmCldkY6ZCgnwgOTRz1NsHkestNp72PsPb8n-GoOpaAu5aU/exec">Booking</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<div class="banner">
  <img src="images/banner.jpg" alt="Selvi Home Stay Rameshwaram">
</div>

<div class="container">
<h2>Booking Form</h2>

<form id="bookingForm">

  <label>Name 
    <input type="text" name="Name" placeholder="e.g. Suresh Kumar" required>
  </label>

  <label>Aadhaar Number 
    <input type="text" name="Aadhaar" placeholder="e.g. 123412341234" required>
  </label>

  <label>Mobile Number 
    <input type="text" name="Mobile" placeholder="e.g. +919123412345" required>
  </label>

  <label>Address 
    <textarea name="Address" rows="2" placeholder="e.g. 12/3 Beach Road, Rameshwaram" required></textarea>
  </label>

  <!-- FromDate / ToDate -->
  <div class="form-row">
    <label style="flex:1">From Date
      <select name="FromDate" id="FromDate" required disabled>
        <option value="">Loading available datesâ€¦</option>
      </select>
    </label>

    <label style="flex:1">To Date
      <select name="ToDate" id="ToDate" required disabled>
        <option value="">Select From Date first</option>
      </select>
    </label>
  </div>

  <!-- Pricing breakdown appears right after dates -->
  <div id="priceInfo" style="margin:8px 0 0 0; font-size:0.95rem; line-height:1.4;"></div>

  <!-- Pay link appears AFTER price breakdown -->
  <p id="payLinkP" style="text-align:center; margin:12px 0; display:none;">
    <a href="#" onclick="openPaymentPopup(); return false;"
       style="color:#b45309; font-weight:600; text-decoration:underline;">
       ðŸ’° Click here to Pay for Selvi Home Stay
    </a>
  </p>

  <div class="form-row">
    <label style="flex:1">Payment Date 
      <!-- readonly so it's included in submit -->
      <input type="date" name="PaymentDate" id="PaymentDate" readonly required>
    </label>
    <div style="flex:1; display:flex; align-items:center; font-size:0.9rem; color:#6b7280; padding-top:8px;">
      If payment was made earlier, please mention the actual date in the Message box.
    </div>
  </div>

  <label>Payment Reference Number 
    <input type="text" name="PaymentRefNo" placeholder="e.g. 1234567890123456" required>
  </label>

  <label>Payment Amount (â‚¹) 
    <input type="number" name="PaymentAmount" placeholder="e.g. 1000" required>
  </label>

  <!-- Members (required) -->
  <div class="form-row" style="align-items:flex-end;">
    <label style="flex:1">Members
      <select name="Members" id="Members" required>
        <option value="">Select Members (3â€“10)</option>
        <option>3</option><option>4</option><option>5</option><option>6</option>
        <option>7</option><option>8</option><option>9</option><option>10</option>
      </select>
    </label>
    <div style="flex:1; padding:6px 8px; color:#6b7280; font-size:0.9rem;">
      Maximum <b>8 Adults + 2 Children</b>.
    </div>
  </div>

  <!-- Message LAST field -->
  <label>Message
    <textarea name="Message" id="Message" rows="3" placeholder="Any notes (e.g., earlier payment date, special requests)"></textarea>
  </label>

  <!-- Source fixed -->
  <input type="hidden" name="Source" value="Website">

<!-- Rules & Regulations -->
<div style="margin:15px 0; padding:10px; border:1px solid #ccc; background:#f9f9f9; border-radius:6px;">
  <p style="margin:0 0 6px 0;"><strong>Rules & Regulations:</strong></p>
  <ul style="margin:0 0 6px 20px; padding:0; list-style-type:disc;">
    <li>Cooking or eating <strong>non-vegetarian food</strong> in the premises is <strong>not allowed</strong>.</li>
    <li><strong>Smoking or drinking alcohol</strong> in the premises is <strong>strictly prohibited</strong>.</li>
  </ul>
  <label style="display:block; margin-top:8px;">
    <input type="checkbox" id="rulesAgree" required>
    I have read and agree to the Rules & Regulations.
  </label>
</div>

  
  <button type="submit">Submit Booking</button>
</form>

<div id="result"></div>
</div>

<footer>
  Â© 2025 Selvi Home Stay <br>
  Designed by <br> Premanandhan Narayanan <br>
  WhatsApp +91 98844 86609
</footer>

<script>
/* === Open payment page in centered popup === */
function openPaymentPopup() {
  const w = 480, h = 650;
  const left = (screen.width / 2) - (w / 2);
  const top = (screen.height / 2) - (h / 2);
  window.open("payments.html", "SelviHomeStayPayment",
              `width=${w},height=${h},top=${top},left=${left},resizable=yes,scrollbars=yes`);
}

/* === Constants === */
const GS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzDFjdza5p55qs8GQI1f_JKtyVK1BzEz4GVAfvjFjp6uvfCiWEBVdnWz7yM14xnPd65/exec";
const DAYS_WINDOW = 60;

/* === Rates (fetched from backend) === */
let RATE_PER_DAY = null;   // from Rates!B1
let GST_PERCENT  = null;   // from Rates!B2
let BASE_PER_DAY = null;   // from Rates!B3 (advance)

/* === Helpers === */
const pad2 = n => (n < 10 ? '0' + n : '' + n);
const inr = new Intl.NumberFormat('en-IN');

function toISODate(d) {
  return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
}
function addDays(date, days) {
  const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  d.setDate(d.getDate() + days);
  return d;
}
function parseISODate(s) {
  const [y, m, d] = s.split('-').map(Number);
  return new Date(y, m - 1, d);
}

/* Build Set of blocked dates (booked nights: [From, To) ) */
function buildBlockedDateSet(bookings) {
  const blocked = new Set();
  bookings.forEach(b => {
    const from = parseISODate(b.FromDate);
    const to = parseISODate(b.ToDate);
    if (isNaN(from) || isNaN(to)) return;
    for (let d = new Date(from); d < to; d.setDate(d.getDate() + 1)) {
      blocked.add(toISODate(d));
    }
  });
  return blocked;
}
function buildBlockedSortedArray(blockedSet) {
  return Array.from(blockedSet).sort();
}
function computeAvailableFromDates(blockedSet) {
  const today = new Date();
  const start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const end = addDays(start, DAYS_WINDOW);
  const options = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const key = toISODate(d);
    if (!blockedSet.has(key)) options.push(key);
  }
  return options;
}

/* âœ… ToDate options: allow checkout ON next FromDate (inclusive) */
function computeToDateOptions(fromISO, blockedSorted) {
  const today = new Date();
  const windowEnd = addDays(new Date(today.getFullYear(), today.getMonth(), today.getDate()), DAYS_WINDOW);
  const start = addDays(parseISODate(fromISO), 1);

  let nextFrom = null;
  for (const iso of blockedSorted) {
    if (iso > fromISO) { nextFrom = iso; break; }
  }

  let endBoundary = windowEnd;
  if (nextFrom) {
    const candidate = parseISODate(nextFrom); // inclusive
    if (candidate < endBoundary) endBoundary = candidate;
  }

  const options = [];
  for (let d = new Date(start); d <= endBoundary; d.setDate(d.getDate() + 1)) {
    options.push(toISODate(d));
  }
  return options;
}

/* Nights between two ISO dates */
function nightsBetween(fromISO, toISO) {
  const f = parseISODate(fromISO);
  const t = parseISODate(toISO);
  return Math.max(0, Math.round((t - f) / (1000*60*60*24)));
}

/* Price breakdown UI */
function renderPrice(fromISO, toISO) {
  const priceDiv = document.getElementById('priceInfo');
  const payLinkP = document.getElementById('payLinkP');
  priceDiv.innerHTML = '';
  payLinkP.style.display = 'none';

  if (!fromISO || !toISO) return;
  const nights = nightsBetween(fromISO, toISO);
  if (nights <= 0) return;

  // fallback safe defaults if rates not fetched
  const rate = Number(RATE_PER_DAY ?? 0);
  const gst  = Number(GST_PERCENT  ?? 0);
  const base = Number(BASE_PER_DAY ?? 1000);

  const gstPerDay = Math.round((rate * gst) / 100);
  const totalPerDay = rate + gstPerDay;

  const advanceTotal = base * nights;
  const fullTotal = totalPerDay * nights;

  // Build breakdown HTML
  const lines = [];
  lines.push(`<div><b>Stay Duration:</b> ${nights} night${nights>1?'s':''}</div>`);
  if (rate && gst) {
    lines.push(`<div style="margin-top:6px;"><b>Full Payment (per day):</b> â‚¹${inr.format(rate)} + GST ${gst}% (â‚¹${inr.format(gstPerDay)}) = <b>â‚¹${inr.format(totalPerDay)}</b></div>`);
    lines.push(`<div><b>Full Total (${nights} night${nights>1?'s':''}):</b> â‚¹${inr.format(fullTotal)}</div>`);
  } else {
    lines.push(`<div style="margin-top:6px; color:#9ca3af;">Rates temporarily unavailable; contact us for full amount.</div>`);
  }
  lines.push(`<div style="margin-top:6px;"><b>Advance Option:</b> â‚¹${inr.format(base)} Ã— ${nights} = <b>â‚¹${inr.format(advanceTotal)}</b></div>`);

  priceDiv.innerHTML = lines.join('');
  payLinkP.style.display = 'block';
}

/* === Init === */
(function init() {
  const payInput = document.getElementById('PaymentDate');
  payInput.value = toISODate(new Date());
  loadRates().finally(loadAvailability);
})();

/* === Fetch Rates once === */
async function loadRates() {
  try {
    const res = await fetch(`${GS_WEBAPP_URL}?action=get_rates`);
    const json = await res.json();
    if (json && typeof json.ratePerDay !== 'undefined') {
      RATE_PER_DAY = Number(json.ratePerDay);
      GST_PERCENT  = Number(json.gstPercent);
      BASE_PER_DAY = Number(json.basePerDay);
    } else {
      // fallback; still allow UI to work
      BASE_PER_DAY = 1000;
    }
  } catch (e) {
    console.warn('Unable to load rates:', e);
    BASE_PER_DAY = 1000;
  }
}

/* === Fetch bookings and populate FromDate dropdown === */
async function loadAvailability() {
  const fromEl = document.getElementById('FromDate');
  const toEl = document.getElementById('ToDate');
  try {
    fromEl.innerHTML = `<option value="">Loading available datesâ€¦</option>`;
    fromEl.disabled = true;
    toEl.innerHTML = `<option value="">Select From Date first</option>`;
    toEl.disabled = true;

    const url = `${GS_WEBAPP_URL}?action=get_bookings`;
    const res = await fetch(url);
    const json = await res.json();

    const bookings = json.data || [];
    bookings.sort((a, b) => a.FromDate.localeCompare(b.FromDate));

    const blockedSet = buildBlockedDateSet(bookings);
    const blockedSorted = buildBlockedSortedArray(blockedSet);
    const availableFromDates = computeAvailableFromDates(blockedSet);

    if (availableFromDates.length === 0) {
      fromEl.innerHTML = `<option value="">No dates available</option>`;
      fromEl.disabled = true;
      return;
    }

    fromEl.innerHTML = `<option value="">Select a check-in date</option>` +
      availableFromDates.map(d => `<option value="${d}">${d}</option>`).join('');
    fromEl.disabled = false;

    fromEl.addEventListener('change', () => {
      const chosen = fromEl.value;
      document.getElementById('priceInfo').innerHTML = '';
      document.getElementById('payLinkP').style.display = 'none';

      if (!chosen) {
        toEl.innerHTML = `<option value="">Select From Date first</option>`;
        toEl.disabled = true;
        return;
      }
      const toOptions = computeToDateOptions(chosen, blockedSorted);
      if (toOptions.length === 0) {
        toEl.innerHTML = `<option value="">No valid To Date after ${chosen}</option>`;
        toEl.disabled = true;
        return;
      }
      toEl.innerHTML = `<option value="">Select your checkout date</option>` +
        toOptions.map(d => `<option value="${d}">${d}</option>`).join('');
      toEl.disabled = false;
    });

    toEl.addEventListener('change', () => {
      const fromISO = fromEl.value;
      const toISO = toEl.value;
      renderPrice(fromISO, toISO);
    });

  } catch (err) {
    console.error(err);
    fromEl.innerHTML = `<option value="">Unable to load dates</option>`;
    fromEl.disabled = true;
  }
}

/* === Booking form submission === */
document.getElementById('bookingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());

  // Validate dates
  if (!data.FromDate || !data.ToDate || data.ToDate <= data.FromDate) {
    document.getElementById('result').innerHTML =
      `<div style='color:red'>Please choose a valid From Date and To Date.</div>`;
    return;
  }
  // Validate Members 3â€“10
  const members = Number(data.Members);
  if (!members || members < 3 || members > 10) {
    document.getElementById('result').innerHTML =
      `<div style='color:red'>Please select Members between 3 and 10.</div>`;
    return;
  }

  data.action = 'create_booking';
  data.Source = 'Website';

  const resDiv = document.getElementById('result');
  resDiv.textContent = 'Submitting...';
  try {
    const res = await fetch(GS_WEBAPP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    // Note: if your backend handles POST via doGet, it will still return JSON here
    const txt = await res.text();
    let json;
    try { json = JSON.parse(txt); } catch { json = { error: 'Invalid server response', raw: txt }; }

    resDiv.innerHTML = json.error
      ? `<div style='color:red'>Error: ${json.error}</div>`
      : `<div style='color:green'>âœ… Booking received! ID: <b>${json.bookingId || ''}</b></div>`;
    if (!json.error) {
      e.target.reset();
      document.getElementById('PaymentDate').value = toISODate(new Date());
      loadAvailability();
      const toEl = document.getElementById('ToDate');
      toEl.innerHTML = `<option value="">Select From Date first</option>`;
      toEl.disabled = true;
      document.getElementById('priceInfo').innerHTML = '';
      document.getElementById('payLinkP').style.display = 'none';
    }
  } catch(err) {
    resDiv.innerHTML = `<div style='color:red'>Error: ${err.message}</div>`;
  }
});
</script>

</body>
</html>
