<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Booking ‚Äî Selvi Home Stay</title>
<link rel="icon" type="image/png" href="images/favicon.png">
<link rel="stylesheet" href="style.css">

<style>
.notice-success {
  margin-top: 20px;
  padding: 14px;
  border-radius: 10px;
  background: #ecfdf5;
  border: 1px solid #a7f3d0;
  color:#065f46;
}
.notice-error {
  margin-top: 20px;
  padding: 14px;
  border-radius: 10px;
  background: #fef2f2;
  border: 1px solid #fecaca;
  color:#7f1d1d;
}
.btn[disabled] {
  opacity:.6;
  cursor:not-allowed;
}
.workflow {
  margin:25px 0;
  padding:18px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
  border-radius:12px;
}
.workflow h3 { margin-top:0; }
.workflow ol { padding-left:20px; line-height:1.7; }
.muted { color:#6b7280; font-size:.92rem; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>

<body>
<div id="nav-placeholder"></div>  
<div class="container">

<h2>Booking Form</h2>

<!-- WORKFLOW SECTION -->
<div class="workflow">
  <h3>üßæ How Booking & Payment Works</h3>
  <ol>
    <li><b>Submit your basic details</b><br>
      <span class="muted">Enter your stay dates and contact information.</span>
    </li>
    <li><b>Receive secure payment link by Email</b><br>
      <span class="muted">We will send you payment details immediately after booking.</span>
    </li>
    <li><b>Make advance or full payment online</b><br>
      <span class="muted">Payments are securely processed via Razorpay.</span>
    </li>
    <li><b>Visit Selvi Home Stay on your booking date</b></li>
    <li><b>Pay remaining balance (if any)</b><br>
      <span class="muted">Balance can be paid before or during stay.</span>
    </li>
  </ol>
</div>

<form id="bookingForm">

<input type="hidden" name="action" value="create_booking">
<input type="hidden" name="Source" value="Website">

<label>Name
  <input type="text" name="Name" required>
</label>

<label>Aadhaar Number
  <input type="text" name="Aadhaar" required>
</label>

<label>Mobile Number
  <input type="text" name="Mobile" required>
</label>

<label>Address
  <textarea name="Address" rows="2" required></textarea>
</label>

<label>From Date
  <input type="text" name="FromDate" id="FromDate" required>
</label>

<label>To Date
  <input type="text" name="ToDate" id="ToDate" required>
</label>

<label>Members
  <select name="Members" required>
    <option value="">Select</option>
    <option>3</option><option>4</option><option>5</option>
    <option>6</option><option>7</option><option>8</option>
    <option>9</option><option>10</option>
  </select>
</label>

<label>WhatsApp Number
  <input type="text" name="Whatsapp">
</label>

<label>Email
  <input type="email" name="Email">
</label>

<label>Coupon Code (optional)
  <input type="text" name="CouponCode" id="CouponCode">
</label>

<label>Message
  <textarea name="Message" rows="3"></textarea>
</label>

<div style="margin:20px 0; padding:15px; border:1px solid #ddd; border-radius:8px; background:#f9fafb;">

  <h4 style="margin-top:0;">üìú Rules & Regulations</h4>

  <ul style="line-height:1.6; padding-left:18px;">
    <li>‚ùå Cooking or eating <b>Non-Vegetarian food</b> is strictly not allowed in our premises.</li>
    <li>‚ùå <b>Alcohol consumption</b> is strictly prohibited during your stay.</li>
  </ul>

  <div style="margin-top:12px;">
    <label style="cursor:pointer;">
      <input type="checkbox" id="rulesAgree" required style="margin-right:8px;">
      I agree to the above Rules & Regulations
    </label>
  </div>

</div>


<button type="submit" id="submitBtn" class="btn">Submit Booking</button>

<div id="formMessage"></div>

</form>
</div>

<script>
const APPS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbxJJUirnar3OBGwszagDNWH_Js0FhYfzKMYyRVl06bH4IOseYcZ3vIRr6izAHERWqko/exec";

document.getElementById("bookingForm").addEventListener("submit", async function(e) {

  e.preventDefault();

  const msgBox = document.getElementById("formMessage");
  const submitBtn = document.getElementById("submitBtn");

  msgBox.innerHTML = "";
  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting...";

  if (!document.getElementById("rulesAgree").checked) {
    alert("Please agree to the rules.");
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Booking";
    return;
  }

  try {

    const formData = new FormData(this);
    const payload = Object.fromEntries(formData.entries());

    // üîπ Validate Coupon (if entered)
    if (payload.CouponCode && payload.CouponCode.trim() !== "") {

      const res = await fetch(
        APPS_SCRIPT_URL + "?action=validate_coupon&coupon=" +
        encodeURIComponent(payload.CouponCode)
      );

      const couponResult = await res.json();

      if (!couponResult.valid) {
        msgBox.className = "notice-error";
        msgBox.innerHTML = "‚ùå Invalid coupon code.";
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Booking";
        return;
      }
    }

    // üîπ Submit Booking
    const response = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      body: new URLSearchParams(payload)
    });


    const result = await response.json();

    if (result.success) {
      msgBox.className = "notice-success";
      msgBox.innerHTML =
        "‚úÖ Booking Created Successfully!<br><br>" +
        "Your Booking ID: <b>" + result.bookingId + "</b><br>" +
        "Payment details will be sent to your Email shortly.";
      this.reset();
    } else {
      msgBox.className = "notice-error";
      msgBox.innerHTML = "‚ùå " + result.error;
    }

  } catch (err) {
  msgBox.className = "notice-error";
  msgBox.innerHTML = "‚ùå " + err.message;
}


  submitBtn.disabled = false;
  submitBtn.textContent = "Submit Booking";
});
</script>

 <script>

const MAX_STAY_DAYS = 5;

async function setupCalendar() {

  const res = await fetch(
    APPS_SCRIPT_URL + "?action=get_bookings"
  );

  const result = await res.json();
  const bookings = result.data || [];
  // üî• Create blockedDates set
const blockedDates = new Set();

bookings.forEach(b => {
  let start = new Date(b.FromDate);
  let end = new Date(b.ToDate);

  while (start < end) {
    blockedDates.add(start.toISOString().split("T")[0]);
    start.setDate(start.getDate() + 1);
  }
});


  const disabledRanges = bookings.map(b => ({
    from: b.FromDate,
    to: new Date(new Date(b.ToDate).getTime() - 86400000)
      .toISOString().split("T")[0]
  }));

  const today = new Date();
  const maxDate = new Date();
  maxDate.setDate(today.getDate() + 60);

  const fromPicker = flatpickr("#FromDate", {
    dateFormat: "Y-m-d",
    minDate: today,
    maxDate: maxDate,
    disable: disabledRanges,

    onChange: function(selectedDates) {

  if (!selectedDates.length) return;

  const selectedFrom = selectedDates[0];

  let allowedDates = [];

  for (let i = 1; i <= MAX_STAY_DAYS; i++) {

    let check = new Date(selectedFrom);
    check.setDate(check.getDate() + i);

    const checkStr = check.toISOString().split("T")[0];

    // üö® STOP immediately if this date is already booked
    if (blockedDates.has(checkStr)) {
      break;
    }

    allowedDates.push(checkStr);
  }

  toPicker.clear();

  if (allowedDates.length === 0) {
    toPicker.set("enable", []);
    return;
  }

  toPicker.set("enable", allowedDates);
  toPicker.set("minDate", allowedDates[0]);
  toPicker.set("maxDate", allowedDates[allowedDates.length - 1]);
}

  
  });

  const toPicker = flatpickr("#ToDate", {
    dateFormat: "Y-m-d",
    disable: disabledRanges
  });

}

setupCalendar();
</script>

<script src="script.js"></script>
</body>
</html>
