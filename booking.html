<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Booking ‚Äî Selvi Home Stay</title>

<link rel="stylesheet" href="https://selvi-home-stay.in/style.css">

<style>
.notice-success {
  margin-top: 20px;
  padding: 14px;
  border-radius: 10px;
  background: #ecfdf5;
  border: 1px solid #a7f3d0;
  color:#065f46;
}
.notice-error {
  margin-top: 20px;
  padding: 14px;
  border-radius: 10px;
  background: #fef2f2;
  border: 1px solid #fecaca;
  color:#7f1d1d;
}
.btn[disabled] {
  opacity:.6;
  cursor:not-allowed;
}
.workflow {
  margin:25px 0;
  padding:18px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
  border-radius:12px;
}
.workflow h3 { margin-top:0; }
.workflow ol { padding-left:20px; line-height:1.7; }
.muted { color:#6b7280; font-size:.92rem; }
</style>
</head>

<body>
<div class="container">

<h2>Booking Form</h2>

<!-- WORKFLOW SECTION -->
<div class="workflow">
  <h3>üßæ How Booking & Payment Works</h3>
  <ol>
    <li><b>Submit your basic details</b><br>
      <span class="muted">Enter your stay dates and contact information.</span>
    </li>
    <li><b>Receive secure payment link by Email</b><br>
      <span class="muted">We will send you payment details immediately after booking.</span>
    </li>
    <li><b>Make advance or full payment online</b><br>
      <span class="muted">Payments are securely processed via Razorpay.</span>
    </li>
    <li><b>Visit Selvi Home Stay on your booking date</b></li>
    <li><b>Pay remaining balance (if any)</b><br>
      <span class="muted">Balance can be paid before or during stay.</span>
    </li>
  </ol>
</div>

<form id="bookingForm">

<input type="hidden" name="action" value="create_booking">
<input type="hidden" name="Source" value="Website">

<label>Name
  <input type="text" name="Name" required>
</label>

<label>Aadhaar Number
  <input type="text" name="Aadhaar" required>
</label>

<label>Mobile Number
  <input type="text" name="Mobile" required>
</label>

<label>Address
  <textarea name="Address" rows="2" required></textarea>
</label>

<label>From Date
  <input type="date" name="FromDate" required>
</label>

<label>To Date
  <input type="date" name="ToDate" required>
</label>

<label>Members
  <select name="Members" required>
    <option value="">Select</option>
    <option>3</option><option>4</option><option>5</option>
    <option>6</option><option>7</option><option>8</option>
    <option>9</option><option>10</option>
  </select>
</label>

<label>WhatsApp Number
  <input type="text" name="Whatsapp">
</label>

<label>Email
  <input type="email" name="Email">
</label>

<label>Coupon Code (optional)
  <input type="text" name="CouponCode" id="CouponCode">
</label>

<label>Message
  <textarea name="Message" rows="3"></textarea>
</label>

<div style="margin:15px 0">
  <label>
    <input type="checkbox" id="rulesAgree" required>
    I agree to the Rules & Regulations
  </label>
</div>

<button type="submit" id="submitBtn" class="btn">Submit Booking</button>

<div id="formMessage"></div>

</form>
</div>

<script>
const APPS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbxJJUirnar3OBGwszagDNWH_Js0FhYfzKMYyRVl06bH4IOseYcZ3vIRr6izAHERWqko/exec";

document.getElementById("bookingForm").addEventListener("submit", async function(e) {

  e.preventDefault();

  const msgBox = document.getElementById("formMessage");
  const submitBtn = document.getElementById("submitBtn");

  msgBox.innerHTML = "";
  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting...";

  if (!document.getElementById("rulesAgree").checked) {
    alert("Please agree to the rules.");
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Booking";
    return;
  }

  try {

    const formData = new FormData(this);
    const payload = Object.fromEntries(formData.entries());

    // üîπ Validate Coupon (if entered)
    if (payload.CouponCode && payload.CouponCode.trim() !== "") {

      const res = await fetch(
        APPS_SCRIPT_URL + "?action=validate_coupon&coupon=" +
        encodeURIComponent(payload.CouponCode)
      );

      const couponResult = await res.json();

      if (!couponResult.valid) {
        msgBox.className = "notice-error";
        msgBox.innerHTML = "‚ùå Invalid coupon code.";
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Booking";
        return;
      }
    }

    // üîπ Submit Booking
    const response = await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      body: new URLSearchParams(payload)
    });


    const result = await response.json();

    if (result.success) {
      msgBox.className = "notice-success";
      msgBox.innerHTML =
        "‚úÖ Booking Created Successfully!<br><br>" +
        "Your Booking ID: <b>" + result.bookingId + "</b><br>" +
        "Payment details will be sent to your Email shortly.";
      this.reset();
    } else {
      msgBox.className = "notice-error";
      msgBox.innerHTML = "‚ùå " + result.error;
    }

  } catch (err) {
  msgBox.className = "notice-error";
  msgBox.innerHTML = "‚ùå " + err.message;
}


  submitBtn.disabled = false;
  submitBtn.textContent = "Submit Booking";
});
</script>
<script>

const MAX_STAY_DAYS = 5;   // üîí Hardcoded max stay

async function setupDateRules() {

  const res = await fetch(
    APPS_SCRIPT_URL + "?action=get_bookings"
  );

  const result = await res.json();
  const bookings = result.data || [];

  const fromInput = document.querySelector('input[name="FromDate"]');
  const toInput = document.querySelector('input[name="ToDate"]');

  const today = new Date();
  today.setHours(0,0,0,0);

  const maxWindow = new Date();
  maxWindow.setDate(today.getDate() + 60);

  const format = d => d.toISOString().split("T")[0];

  // üîπ Create blocked dates set
  const blocked = new Set();

  bookings.forEach(b => {
    let start = new Date(b.FromDate);
    let end = new Date(b.ToDate);

    while (start < end) {
      blocked.add(format(start));
      start.setDate(start.getDate() + 1);
    }
  });

  // üîπ Find first available date
  let firstAvailable = new Date(today);
  while (blocked.has(format(firstAvailable))) {
    firstAvailable.setDate(firstAvailable.getDate() + 1);
  }

  fromInput.min = format(firstAvailable);
  fromInput.max = format(maxWindow);

  // üîπ FromDate Change
  fromInput.addEventListener("change", function() {

    const selectedFrom = new Date(this.value);

    if (blocked.has(this.value)) {
      alert("This date is already booked.");
      this.value = "";
      return;
    }

    // Check if next day is booked
    const nextDay = new Date(selectedFrom);
    nextDay.setDate(nextDay.getDate() + 1);

    if (blocked.has(format(nextDay))) {
      alert("You cannot start booking on this date because next day is already booked.");
      this.value = "";
      return;
    }

    // ToDate must start from next day
    const minTo = new Date(selectedFrom);
    minTo.setDate(minTo.getDate() + 1);

    // Max stay limit
    const maxTo = new Date(selectedFrom);
    maxTo.setDate(maxTo.getDate() + MAX_STAY_DAYS);

    toInput.min = format(minTo);
    toInput.max = format(maxTo);
    toInput.value = "";
  });

  // üîπ ToDate Change Validation
  toInput.addEventListener("change", function() {

    const selectedFrom = new Date(fromInput.value);
    const selectedTo = new Date(this.value);

    let temp = new Date(selectedFrom);

    while (temp < selectedTo) {
      if (blocked.has(format(temp))) {
        alert("Selected range overlaps with an existing booking.");
        this.value = "";
        return;
      }
      temp.setDate(temp.getDate() + 1);
    }

  });

}

setupDateRules();

</script>

</body>
</html>
