<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Booking — Selvi Home Stay</title>

<link rel="icon" type="image/png" href="https://selvi-home-stay.in/images/favicon.png">
<link rel="stylesheet" href="https://selvi-home-stay.in/style.css">

<style>
  .form-row { display:flex; gap:12px; flex-wrap:wrap; }
  label { display:block; }
  .muted { color:#6b7280; font-size:.92rem; }
  .price { margin:8px 0; font-size:0.95rem; line-height:1.4; }
  .banner img { width:100%; height:auto; display:block; }
  .notice-success {
    margin-top: 20px; padding: 14px 16px; border-radius: 12px;
    background: #ecfdf5; border: 1px solid #a7f3d0; color:#065f46;
  }
  .notice-error {
    margin-top: 20px; padding: 14px 16px; border-radius: 12px;
    background: #fef2f2; border: 1px solid #fecaca; color:#7f1d1d;
  }
  .btn[disabled] { opacity: .6; cursor: not-allowed; }
  .pay-link { margin-top: 10px; display:inline-block; font-weight:bold; color:#065f46; }
</style>

<!-- ✅ Meta Pixel Code -->
<script async src="https://connect.facebook.net/en_US/fbevents.js"></script>
<script>
  function initFBPixel() {
    if (typeof fbq === 'function') {
      fbq('init', '793878913410553');
      fbq('track', 'PageView');
      console.log('✅ Meta Pixel initialized manually');
    } else {
      setTimeout(initFBPixel, 500);
    }
  }
  window.fbq = window.fbq || function() {
    (window.fbq.callMethod ?
      window.fbq.callMethod.apply(window.fbq, arguments) : window.fbq.queue.push(arguments));
  };
  window.fbq.queue = [];
  document.addEventListener('DOMContentLoaded', initFBPixel);
</script>
<noscript>
  <img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=793878913410553&ev=PageView&noscript=1"/>
</noscript>
<!-- ✅ End Meta Pixel Code -->

<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0f172a">

<!-- ✅ Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('✅ Service Worker registered:', reg.scope))
        .catch(err => console.log('❌ Service Worker registration failed:', err));
    });
  }
</script>
</head>

<body>
<header>
  <h1>Selvi Home Stay</h1>
  <div class="menu-toggle"><span></span><span></span><span></span></div>
  <nav>
    <a href="index.html">Home</a>
    <a href="gallery.html">Photos</a>
    <a href="videos.html">Videos</a>
    <a href="places.html">Places to Visit</a>
    <a href="booking.html" class="active">Booking</a>
    <a href="contact.html">Contact</a>
    <a href="sitemap.html">Site Map</a>
    <a href="testimonials.html">Testimonials</a>
  </nav>
</header>

<div class="banner">
  <img src="https://selvi-home-stay.in/images/banner.jpg" alt="Selvi Home Stay Rameshwaram">
</div>

<div class="container">
<h2>Booking Form</h2>

<form id="bookingForm" method="POST"
  action="https://script.google.com/macros/s/AKfycbxvdeGzk4LSpRbk-AzegMScBzRKNwiXaAO5tkYn5X-r8s1gjwFzdjiMvBHZy1OZpt96/exec">
  <input type="hidden" name="action" value="create_booking">
  <input type="hidden" name="Source" value="Website">

  <label>Name 
    <input type="text" name="Name" placeholder="e.g. Name as in Aadhaar Card" required>
  </label>

  <label>Aadhaar Number 
    <input type="text" name="Aadhaar" placeholder="e.g. 123412341234" required>
  </label>

  <label>Mobile Number 
    <input type="text" name="Mobile" placeholder="e.g. 9123412345" required>
  </label>

  <label>Address 
    <textarea name="Address" rows="2" placeholder="e.g. 12/3 Beach Road, Chennai, Tamil Nadu" required></textarea>
  </label>

  <div class="form-row">
    <label style="flex:1">From Date
      <select name="FromDate" id="FromDate" required disabled>
        <option value="">Loading available dates…</option>
      </select>
    </label>

    <label style="flex:1">To Date
      <select name="ToDate" id="ToDate" required disabled>
        <option value="">Select From Date first</option>
      </select>
    </label>
  </div>

  <div id="priceInfo" class="price"></div>

  <div class="form-row">
    <label style="flex:1">Payment Date
      <input type="date" name="PaymentDate" id="PaymentDate" readonly required>
    </label>
    <div style="flex:1;display:flex;align-items:center;" class="muted">
      If payment was made earlier, please mention the actual date in the Message box.
    </div>
  </div>

  <label>Payment Reference Number 
    <input type="text" name="PaymentRefNo" placeholder="e.g. 123456789012" required>
  </label>

  <label>Payment Amount (₹) 
    <input type="number" name="PaymentAmount" placeholder="e.g. Minimum ₹1000/day" required>
  </label>

  <div class="form-row" style="align-items:flex-end;">
    <label style="flex:1">Members
      <select name="Members" id="Members" required>
        <option value="">Select Members (3–10)</option>
        <option>3</option><option>4</option><option>5</option><option>6</option>
        <option>7</option><option>8</option><option>9</option><option>10</option>
      </select>
    </label>
    <div style="flex:1;padding:6px 8px;" class="muted">
      Maximum <b>8 Adults + 2 Children</b>.
    </div>
  </div>

  <label>WhatsApp Number <span class="muted">(optional)</span>
    <input type="text" name="Whatsapp">
  </label>

  <label>Email <span class="muted">(optional)</span>
    <input type="email" name="Email">
  </label>

  <label>Message
    <textarea name="Message" rows="3"></textarea>
  </label>

  <div style="margin:15px 0;padding:10px;border:1px solid #ccc;background:#f9f9f9;border-radius:6px;">
    <p><strong>Rules & Regulations:</strong></p>
    <ul style="margin:0 0 6px 20px;padding:0;list-style-type:disc;">
      <li>No non-vegetarian food allowed inside.</li>
      <li>Smoking or drinking alcohol is strictly prohibited.</li>
    </ul>
    <label>
      <input type="checkbox" id="rulesAgree" required>
      I have read and agree to the Rules & Regulations.
    </label>
  </div>

  <button id="submitBtn" type="submit" class="btn">Submit Booking</button>
  <div id="confirmationArea"></div>
</form>
</div>

<footer>
  © 2025 Selvi Home Stay <br>
  Designed by <br> Premanandhan Narayanan <br>
  WhatsApp +91 98844 86609
</footer>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvdeGzk4LSpRbk-AzegMScBzRKNwiXaAO5tkYn5X-r8s1gjwFzdjiMvBHZy1OZpt96/exec";
const DAYS_WINDOW = 60;
let RATES = { ratePerDay: 4760, gstPercent: 5, basePerDay: 1000 };

// small helper utilities
const pad2 = n => (n<10 ? '0'+n : n);
function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function addDays(dt,n){ const x=new Date(dt); x.setDate(x.getDate()+n); return x; }
function parseISO(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function disableForm(formEl){ [...formEl.elements].forEach(el => el.disabled = true); }

// JSONP fetch to bypass CORS
function jsonpFetch(url) {
  return new Promise((resolve, reject) => {
    const cb = 'cb' + Date.now() + Math.floor(Math.random()*1000);
    window[cb] = function(data) {
      resolve(data);
      try { delete window[cb]; } catch(_) {}
      script.remove();
    };
    const script = document.createElement('script');
    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    script.onerror = () => reject(new Error('JSONP load error'));
    document.head.appendChild(script);
  });
}

// display pricing details
function showPrice(fromISO, toISO) {
  const el = document.getElementById('priceInfo');
  if (!fromISO || !toISO) return el.innerHTML = '';
  const nights = (parseISO(toISO) - parseISO(fromISO)) / (1000*60*60*24);
  if (nights <= 0) return el.innerHTML = '';

  const base = RATES.basePerDay * nights;
  const full = RATES.ratePerDay * nights;
  const gst = Math.round(full * RATES.gstPercent / 100);
  const total = full + gst;

  el.innerHTML = `
    <div><b>Stay:</b> ${nights} night(s)</div>
    <div>Advance: ₹${RATES.basePerDay} × ${nights} = <b>₹${base}</b></div>
    <div>Full: ₹${RATES.ratePerDay}/day</div>
    <div>GST @${RATES.gstPercent}% = ₹${gst}</div>
    <div><b>Total: ₹${total}</b></div>
    <a class="pay-link" href="payments.html" target="_blank">➡ Proceed to Payment</a>
  `;
}

// load available dates
(async function init(){
  document.getElementById('PaymentDate').value = toISODate(new Date());
  const fromEl = document.getElementById('FromDate');
  const toEl = document.getElementById('ToDate');
  try {
    const ratesData = await jsonpFetch(`${APPS_SCRIPT_URL}?action=get_rates`);
    if (ratesData) RATES = ratesData;
  } catch(e){ console.warn('Rate load failed', e); }

  try {
    const json = await jsonpFetch(`${APPS_SCRIPT_URL}?action=get_bookings`);
    const bookings = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
    const blocked = new Set();
    bookings.forEach(b=>{
      const f=parseISO(b.FromDate), t=parseISO(b.ToDate);
      for(let d=new Date(f); d<t; d.setDate(d.getDate()+1)) blocked.add(toISODate(d));
    });

    const today = new Date(), end = addDays(today, DAYS_WINDOW);
    const available = [];
    for(let d=new Date(today); d<=end; d.setDate(d.getDate()+1)){
      const iso = toISODate(d);
      if(!blocked.has(iso)) available.push(iso);
    }

    fromEl.innerHTML = '<option value="">Select check-in date</option>' + available.map(d=>`<option value="${d}">${d}</option>`).join('');
    fromEl.disabled = false;

    fromEl.addEventListener('change', ()=>{
      const start = fromEl.value;
      if(!start) return;
      const toList=[];
      for(let d=addDays(parseISO(start),1); d<=end; d.setDate(d.getDate()+1)){
        const iso=toISODate(d);
        if(blocked.has(iso)) break;
        toList.push(iso);
      }
      toEl.innerHTML = '<option value="">Select check-out date</option>' + toList.map(d=>`<option value="${d}">${d}</option>`).join('');
      toEl.disabled=false;
    });

    toEl.addEventListener('change', ()=>showPrice(fromEl.value,toEl.value));
  } catch(e){ console.error('Failed to load dates', e); }
})();

<script>
(function setupBookingFlow() {
  const form = document.getElementById('bookingForm');
  const submitBtn = document.getElementById('submitBtn');
  const confirmationArea = document.getElementById('confirmationArea');
  window._selviPopupRef = null; // keep global ref for closing later

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    if (!document.getElementById('rulesAgree').checked) {
      alert("Please agree to the Rules & Regulations before submitting.");
      return;
    }

    // ✅ Open small popup
    const w = 420, h = 400;
    const left = window.screenX + (window.outerWidth - w) / 2;
    const top = window.screenY + (window.outerHeight - h) / 2;
    const popupRef = window.open('', 'SelviPopup',
      `width=${w},height=${h},top=${top},left=${left},resizable=no,scrollbars=yes`);

    if (!popupRef) {
      alert("Please allow pop-ups for this website to continue your booking.");
      return;
    }

    // keep reference for postMessage close
    window._selviPopupRef = popupRef;

    form.target = 'SelviPopup';
    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting…";

    // ✅ Submit form to Apps Script
    form.submit();
  });
})();
</script>

<!-- ✅ Safe Message Listener -->
<script>
(function secureMessageListener() {
  const TRUSTED_ORIGINS = new Set(['https://script.google.com']);

  window.addEventListener('message', (event) => {
    try {
      const origin = (event.origin || '').toLowerCase();
      if (!TRUSTED_ORIGINS.has(origin)) return;
    } catch (err) { return; }

    const data = event.data;
    if (!data || typeof data !== 'object') return;
    if (!('success' in data) || typeof data.success !== 'boolean') return;

    const form = document.getElementById('bookingForm');
    const submitBtn = document.getElementById('submitBtn');
    const confirmationArea = document.getElementById('confirmationArea');

    if (data.success) {
      confirmationArea.className = 'notice-success';
      confirmationArea.innerHTML = `
        <div>✅ <b>Booking Confirmed!</b></div>
        <div>Your Booking ID: <b>${data.bookingId || 'N/A'}</b></div>
        <div>We’ll contact you via Phone / WhatsApp / Email.</div>
      `;
      [...form.elements].forEach(el => el.disabled = true);
      if (typeof fbq === 'function') fbq('track','Lead');
    } else {
      confirmationArea.className = 'notice-error';
      confirmationArea.textContent = data.error || '❌ Booking failed. Please try again.';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Booking';
    }

    try { if (window._selviPopupRef) { window._selviPopupRef.close(); window._selviPopupRef = null; } } catch(_) {}
  }, false);
})();
</script>
</body>
</html>
