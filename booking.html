<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Booking — Selvi Home Stay</title>

<link rel="icon" type="image/png" href="https://selvi-home-stay.in/images/favicon.png">
<link rel="stylesheet" href="https://selvi-home-stay.in/style.css">

<style>
  .form-row { display:flex; gap:12px; flex-wrap:wrap; }
  label { display:block; }
  .muted { color:#6b7280; font-size:.92rem; }
  .price { margin:8px 0; font-size:0.95rem; line-height:1.4; }
  .banner img { width:100%; height:auto; display:block; }
  .notice-success {
    margin-top: 20px; padding: 14px 16px; border-radius: 12px;
    background: #ecfdf5; border: 1px solid #a7f3d0; color:#065f46;
  }
  .notice-error {
    margin-top: 20px; padding: 14px 16px; border-radius: 12px;
    background: #fef2f2; border: 1px solid #fecaca; color:#7f1d1d;
  }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }
  .pay-link { margin-top:10px; display:inline-block; font-weight:bold; color:#065f46; }
</style>
</head>

<body>
<header>
  <h1>Selvi Home Stay</h1>
  <div class="menu-toggle"><span></span><span></span><span></span></div>
  <nav>
    <a href="index.html">Home</a>
    <a href="gallery.html">Photos</a>
    <a href="videos.html">Videos</a>
    <a href="places.html">Places to Visit</a>
    <a href="booking.html" class="active">Booking</a>
    <a href="contact.html">Contact</a>
    <a href="sitemap.html">Site Map</a>
    <a href="testimonials.html">Testimonials</a>
  </nav>
</header>

<div class="banner">
  <img src="https://selvi-home-stay.in/images/banner.jpg" alt="Selvi Home Stay Rameshwaram">
</div>

<div class="container">
  <h2>Booking Form</h2>

  <form id="bookingForm" method="POST"
        action="https://script.google.com/macros/s/AKfycbxvdeGzk4LSpRbk-AzegMScBzRKNwiXaAO5tkYn5X-r8s1gjwFzdjiMvBHZy1OZpt96/exec">
    <input type="hidden" name="action" value="create_booking">
    <input type="hidden" name="Source" value="Website">

    <label>Name
      <input type="text" name="Name" placeholder="e.g. Name as in Aadhaar Card" required>
    </label>

    <label>Aadhaar Number
      <input type="text" name="Aadhaar" placeholder="e.g. 123412341234" required>
    </label>

    <label>Mobile Number
      <input type="text" name="Mobile" placeholder="e.g. 9123412345" required>
    </label>

    <label>Address
      <textarea name="Address" rows="2" placeholder="e.g. 12/3 Beach Road, Chennai, Tamil Nadu" required></textarea>
    </label>

    <div class="form-row">
      <label style="flex:1">From Date
        <select name="FromDate" id="FromDate" required disabled>
          <option value="">Loading available dates…</option>
        </select>
      </label>

      <label style="flex:1">To Date
        <select name="ToDate" id="ToDate" required disabled>
          <option value="">Select From Date first</option>
        </select>
      </label>
    </div>

    <div id="priceInfo" class="price"></div>

    <div class="form-row">
      <label style="flex:1">Payment Date
        <input type="date" name="PaymentDate" id="PaymentDate" readonly required>
      </label>
      <div style="flex:1;display:flex;align-items:center;" class="muted">
        If payment was made earlier, mention actual date in Message.
      </div>
    </div>

    <label>Payment Reference Number
      <input type="text" name="PaymentRefNo" placeholder="e.g. 123456789012" required>
    </label>

    <label>Payment Amount (₹)
      <input type="number" name="PaymentAmount" placeholder="e.g. Minimum ₹1000/day" required>
    </label>

    <div class="form-row" style="align-items:flex-end;">
      <label style="flex:1">Members
        <select name="Members" id="Members" required>
          <option value="">Select Members (3–10)</option>
          <option>3</option><option>4</option><option>5</option><option>6</option>
          <option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
      </label>
      <div style="flex:1;padding:6px 8px;" class="muted">
        Maximum <b>8 Adults + 2 Children</b>.
      </div>
    </div>

    <label>WhatsApp Number <span class="muted">(optional)</span>
      <input type="text" name="Whatsapp">
    </label>

    <label>Email <span class="muted">(optional)</span>
      <input type="email" name="Email">
    </label>

    <label>Message
      <textarea name="Message" rows="3"></textarea>
    </label>

    <div style="margin:15px 0;padding:10px;border:1px solid #ccc;background:#f9f9f9;border-radius:6px;">
      <p><strong>Rules & Regulations:</strong></p>
      <ul style="margin:0 0 6px 20px;padding:0;list-style-type:disc;">
        <li>No non-vegetarian food allowed inside.</li>
        <li>Smoking or drinking alcohol is strictly prohibited.</li>
      </ul>
      <label>
        <input type="checkbox" id="rulesAgree" required>
        I have read and agree to the Rules & Regulations.
      </label>
    </div>

    <button id="submitBtn" type="submit" class="btn">Submit Booking</button>
    <div id="confirmationArea"></div>
  </form>
</div>

<footer>
  © 2025 Selvi Home Stay <br>
  Designed by <br> Premanandhan Narayanan Greater Chennai <br>
  WhatsApp +91 98844 86609
</footer>
<script>
/* CONFIG */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvdeGzk4LSpRbk-AzegMScBzRKNwiXaAO5tkYn5X-r8s1gjwFzdjiMvBHZy1OZpt96/exec";
const DAYS_WINDOW = 60;

/* HELPERS */
const pad2 = n => (n<10 ? '0'+n : ''+n);
function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function addDays(dt,n){ const x=new Date(dt.getFullYear(),dt.getMonth(),dt.getDate()); x.setDate(x.getDate()+n); return x; }
function parseISO(s){ const [y,m,d] = (s||'').split('-').map(Number); return new Date(y,m-1,d); }

/* STATE */
let RATES = { ratePerDay: 4760, gstPercent: 5, basePerDay: 1000 }; // fallback defaults

/* UI functions */
function showPrice(fromISO, toISO) {
  const el = document.getElementById('priceInfo');
  if (!fromISO || !toISO) { el.innerHTML=''; return; }
  const nights = (parseISO(toISO) - parseISO(fromISO)) / (1000*60*60*24);
  if (nights <= 0) { el.innerHTML=''; return; }

  const perDay = Number(RATES.ratePerDay);
  const gstPct = Number(RATES.gstPercent);
  const basePerDay = Number(RATES.basePerDay);

  const baseTotal = basePerDay * nights;
  const fullSubtotal = perDay * nights;
  const gstAmount = Math.round(fullSubtotal * gstPct / 100);
  const fullTotal = fullSubtotal + gstAmount;

  el.innerHTML = `
    <div><b>Stay:</b> ${nights} night(s)</div>
    <div>Advance: ₹${basePerDay} × ${nights} = <b>₹${baseTotal}</b></div>
    <div>Full (per day): ₹${perDay}</div>
    <div>GST @ ${gstPct}% = ₹${gstAmount}</div>
    <div><b>Total: ₹${fullTotal}</b></div>
    <a class="pay-link" href="payments.html" target="_blank">➡ Proceed to Payment</a>
  `;
}

/* Build blocked date set & helpers for options */
function buildBlockedSet(bookings){
  const blocked = new Set();
  bookings.forEach(b => {
    const f = parseISO(b.FromDate); const t = parseISO(b.ToDate);
    if (isNaN(f) || isNaN(t)) return;
    for (let d = new Date(f); d < t; d.setDate(d.getDate()+1)) {
      blocked.add(toISODate(d));
    }
  });
  return blocked;
}
function computeAvailableFromDates(blocked){
  const start = new Date(); start.setHours(0,0,0,0);
  const end = addDays(start, DAYS_WINDOW);
  const out = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
    const iso = toISODate(d);
    if (!blocked.has(iso)) out.push(iso);
  }
  return out;
}
function computeToOptions(fromISO, blockedSorted){
  const today = new Date(); today.setHours(0,0,0,0);
  const windowEnd = addDays(today, DAYS_WINDOW);
  let nextBlocked = null;
  for (const iso of blockedSorted) {
    if (iso > fromISO) { nextBlocked = iso; break; }
  }
  let endBoundary = windowEnd;
  if (nextBlocked) {
    const nb = parseISO(nextBlocked);
    if (nb < endBoundary) endBoundary = nb;
  }
  const arr = [];
  for (let d = addDays(parseISO(fromISO), 1); d <= endBoundary; d.setDate(d.getDate()+1)) {
    arr.push(toISODate(d));
  }
  return arr;
}

/* INIT: load rates and bookings, populate selects */
(async function init(){
  document.getElementById('PaymentDate').value = toISODate(new Date());
  const fromEl = document.getElementById('FromDate');
  const toEl = document.getElementById('ToDate');

  try {
    const r = await fetch(`${APPS_SCRIPT_URL}?action=get_rates`, { cache:'no-store' });
    if (r.ok) {
      const data = await r.json();
      if (data && typeof data.ratePerDay !== 'undefined') RATES = data;
    }
  } catch (err) { console.warn('Could not load rates', err); }

  try {
    const r = await fetch(`${APPS_SCRIPT_URL}?action=get_bookings`, { cache:'no-store' });
    if (!r.ok) throw new Error('Failed fetching bookings');
    const json = await r.json();
    const bookings = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
    const blocked = buildBlockedSet(bookings);
    const blockedSorted = Array.from(blocked).sort();
    const availableFrom = computeAvailableFromDates(blocked);
    if (availableFrom.length === 0) {
      fromEl.innerHTML = '<option value="">No dates available</option>';
      fromEl.disabled = true;
      return;
    }
    fromEl.innerHTML = '<option value="">Select check-in date</option>' +
                       availableFrom.map(d => `<option value="${d}">${d}</option>`).join('');
    fromEl.disabled = false;
    fromEl.addEventListener('change', () => {
      const start = fromEl.value;
      document.getElementById('priceInfo').innerHTML = '';
      if (!start) {
        toEl.innerHTML = '<option value="">Select From Date first</option>';
        toEl.disabled = true;
        return;
      }
      const toOptions = computeToOptions(start, blockedSorted);
      if (toOptions.length === 0) {
        toEl.innerHTML = `<option value="">No valid To Date after ${start}</option>`;
        toEl.disabled = true;
        return;
      }
      toEl.innerHTML = '<option value="">Select checkout date</option>' +
                       toOptions.map(d => `<option value="${d}">${d}</option>`).join('');
      toEl.disabled = false;
      toEl.onchange = () => showPrice(start, toEl.value);
    });
  } catch (err) {
    console.error('Failed to load bookings', err);
    fromEl.innerHTML = '<option value="">Unable to load dates</option>';
    fromEl.disabled = true;
  }
})();

/* ✅ SUBMIT + POPUP HANDLER */
(function setupSubmitPopup() {
  const form = document.getElementById('bookingForm');
  const btn = document.getElementById('submitBtn');
  const confirmationArea = document.getElementById('confirmationArea');
  window._selviPopupRef = null;

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!document.getElementById('rulesAgree').checked) {
      alert('Please agree to the Rules & Regulations before submitting.');
      return;
    }
    const f = form.FromDate?.value, t = form.ToDate?.value;
    if (!f || !t || t <= f) {
      alert('Please choose valid From and To dates.');
      return;
    }
    btn.disabled = true;
    btn.textContent = 'Submitting…';
    const w = 420, h = 460;
    const left = window.screenX + Math.max(0, (window.outerWidth - w) / 2);
    const top = window.screenY + Math.max(0, (window.outerHeight - h) / 2);
    const popup = window.open('', 'SelviPopup', `width=${w},height=${h},top=${top},left=${left},resizable=no,scrollbars=yes`);
    if (!popup) {
      alert('Please allow pop-ups for this website to continue your booking.');
      btn.disabled = false;
      btn.textContent = 'Submit Booking';
      return;
    }
    window._selviPopupRef = popup;
    form.target = 'SelviPopup';
    form.submit();

    // ✅ Detect if popup manually closed
    const popupMonitor = setInterval(() => {
      if (!window._selviPopupRef || window._selviPopupRef.closed) {
        clearInterval(popupMonitor);
        window.location.href = 'index.html';
      }
    }, 1000);

    // ✅ Auto-timeout fallback
    setTimeout(() => {
      if (!window._selviPopupRef || window._selviPopupRef.closed) return;
      try { window._selviPopupRef.close(); } catch (_) {}
      window._selviPopupRef = null;
      window.location.href = 'index.html';
    }, 15000);
  });
})();

/* ✅ SECURE MESSAGE LISTENER */
(function secureMessageListener() {
  const TRUSTED_ORIGINS = new Set(['https://script.google.com']);
  let bookingHandled = false;
  window.addEventListener('message', (event) => {
    try {
      const origin = (event.origin || '').toLowerCase();
      if (!TRUSTED_ORIGINS.has(origin)) return;
    } catch (err) { return; }
    const data = event.data;
    if (bookingHandled) return;
    if (!data || typeof data !== 'object') return;
    if (!('success' in data) || typeof data.success !== 'boolean') return;
    bookingHandled = true;
    const form = document.getElementById('bookingForm');
    const submitBtn = document.getElementById('submitBtn');
    const confirmationArea = document.getElementById('confirmationArea');
    if (data.success) {
      confirmationArea.className = 'notice-success';
      confirmationArea.innerHTML = `
        <div>✅ <b>Booking Confirmed!</b></div>
        <div>Your Booking ID: <b>${data.bookingId || 'N/A'}</b></div>
        <div>We’ll contact you via Phone / WhatsApp / Email.</div>
        <div>This window will close automatically in 15 seconds. Kindly wait.....</div>
        
      `;
      [...form.elements].forEach(el => el.disabled = true);
      submitBtn.disabled = true;
      if (typeof fbq === 'function') fbq('track','Lead');
    } else {
      confirmationArea.className = 'notice-error';
      confirmationArea.textContent = data.error || '❌ Booking failed. Please try again.';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Booking';
    }
    try {
      if (window._selviPopupRef && !window._selviPopupRef.closed) {
        window._selviPopupRef.close();
      }
      window._selviPopupRef = null;
    } catch (_) {}
  }, false);
})();
</script>


</body>
</html>
