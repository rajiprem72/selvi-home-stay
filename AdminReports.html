<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Reports - Selvi Home Stay</title>

<link rel="stylesheet" href="style.css">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}

.admin-container {
  max-width: 1000px;
  margin: 40px auto;
  padding: 20px;
}

button {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 14px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

th {
  background: #f2f2f2;
}

.mark-btn {
  padding: 6px 10px;
  background: green;
  color: white;
  border: none;
  cursor: pointer;
  border-radius: 4px;
}

/* Calendar Styles */
.calendar-container {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.month {
  border: 1px solid #ccc;
  padding: 10px;
  flex: 1;
  min-width: 280px;
}

.month h3 {
  text-align: center;
}

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
}

.day-name {
  font-weight: bold;
  text-align: center;
}

.day {
  padding: 8px;
  text-align: center;
  border-radius: 5px;
  font-size: 13px;
}

.free {
  background-color: #4CAF50;
  color: white;
}

.booked-light {
  background-color: #64B5F6;
  color: white;
}

.booked-dark {
  background-color: #1976D2;
  color: white;
}

.outside-range {
  background-color: #eee;
  color: #999;
}

@media (max-width: 768px) {
  .calendar-container {
    flex-direction: column;
  }
}
</style>
</head>

<body>

<div id="nav-placeholder"></div>

<div class="admin-container">

<h2>Admin Reports</h2>

<!-- ================= MENU SECTION ================= -->
<div id="adminMenu">

<button onclick="location.href='GuestDetails.html'">
1. Guest Details (CREATED/PARTIAL/PAID)
</button>

<button onclick="location.href='UpdatePayments.html'">
2. Update Payments
</button>

<button onclick="location.href='CreateInvoice.html'">
3. Create Invoice
</button>  

<button onclick="loadCommissionData()">
4. Commission Ledger (Pay Commission & Click )
</button>

<button onclick="sendWelcomeEmails()">
5. Send Welcome Email (Tomorrow Arrivals)
</button>

<button onclick="showCalendar()">
6. Booking Calendar (Next 60 Days)
</button>

<button onclick="loadUpcomingGuests()">
7. Guest List (Next 60 Days)
</button>

<button onclick="loadReferralPartners()">
8. Referral Partner Report
</button>

  

<div id="welcomeReport"></div>
<div id="commissionSection"></div>

</div>


<!-- ================= CALENDAR SECTION ================= -->
<div id="calendarSection" style="display:none;">

<button onclick="showMenu()">â¬… Back to Admin Menu</button>

<h3>Booking Calendar (Next 60 Days)</h3>

<div id="calendarContainer" class="calendar-container"></div>

</div>

</div>

<!-- ================= GUEST LIST SECTION ================= -->

<div id="guestSection" style="display:none;">
  
  <button onclick="showMenu()">â¬… Back to Admin Menu</button>

  <h3>Guest List - Next 60 Days</h3>

  <div id="guestTable"></div>

</div>

<!-- ================= REFERRAL PARTNER SECTION ================= -->
<div id="referralSection" style="display:none;">
  
  <button onclick="showMenu()">â¬… Back to Admin Menu</button>

  <h3>Referral Partner Report</h3>

  <div id="referralTable"></div>
  <div id="referralCommissionDetails"></div>

</div>

  
<script>

const API_URL = "https://script.google.com/macros/s/AKfycbxJJUirnar3OBGwszagDNWH_Js0FhYfzKMYyRVl06bH4IOseYcZ3vIRr6izAHERWqko/exec";

/* ===================== MENU SWITCH ===================== */

function showCalendar() {
  document.getElementById("adminMenu").style.display = "none";
  document.getElementById("calendarSection").style.display = "block";
  loadBookings();
}

function showMenu() {
  document.getElementById("calendarSection").style.display = "none";
  document.getElementById("adminMenu").style.display = "block";
}

/* ===================== CALENDAR LOGIC ===================== */
function loadBookings() {

  document.getElementById("calendarContainer").innerHTML = "Loading...";

  fetch(API_URL + "?action=get_bookings")
  .then(res => res.json())
  .then(response => {

  const bookings = response.data || [];
  bookings.sort((a, b) => {
  return new Date(a.checkin) - new Date(b.checkin);
});
  

  if (!Array.isArray(bookings)) {
    document.getElementById("calendarContainer").innerHTML =
      "No booking data available.";
    return;
  }


    console.log(bookings);   // ðŸ”¥ check browser console

    if (!bookings || bookings.length === 0) {
      document.getElementById("calendarContainer").innerHTML = 
        "<p>No bookings found.</p>";
      return;
    }

    document.getElementById("calendarContainer").innerHTML = "";

    const today = new Date();
    today.setHours(0,0,0,0);

    const maxDate = new Date();
    maxDate.setDate(today.getDate() + 60);
    maxDate.setHours(0,0,0,0);

    const months = getMonthsInRange(today, maxDate);

    months.forEach(m => {
      createMonth(m.month, m.year, bookings, today, maxDate);
    });

  })
  .catch(err => {
    document.getElementById("calendarContainer").innerHTML =
      "Error loading bookings.";
    console.error(err);
  });
}


function getMonthsInRange(start, end) {
  let months = [];
  let current = new Date(start.getFullYear(), start.getMonth(), 1);

  while (current <= end) {
    months.push({
      month: current.getMonth(),
      year: current.getFullYear()
    });
    current.setMonth(current.getMonth() + 1);
  }
  return months;
}

function createMonth(month, year, bookings, today, maxDate) {

  const container = document.getElementById("calendarContainer");

  const monthDiv = document.createElement("div");
  monthDiv.className = "month";

  const monthName = new Date(year, month).toLocaleString('default', { month: 'long' });
  monthDiv.innerHTML = `<h3>${monthName} ${year}</h3>`;

  const calendar = document.createElement("div");
  calendar.className = "calendar";

  const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  dayNames.forEach(day => {
    const d = document.createElement("div");
    d.className = "day-name";
    d.innerText = day;
    calendar.appendChild(d);
  });

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  for (let i = 0; i < firstDay; i++) {
    calendar.appendChild(document.createElement("div"));
  }

  for (let day = 1; day <= daysInMonth; day++) {

    const currentDate = new Date(year, month, day);
    currentDate.setHours(0,0,0,0);

    const dateStr =
    currentDate.getFullYear() + "-" +
    String(currentDate.getMonth() + 1).padStart(2, '0') + "-" +
    String(currentDate.getDate()).padStart(2, '0');


    const dayDiv = document.createElement("div");
    dayDiv.className = "day";
    dayDiv.innerText = day;

    if (currentDate < today || currentDate > maxDate) {
      dayDiv.classList.add("outside-range");
    } else {

      let bookingIndex = -1;

      bookings.forEach((booking, index) => {
        if (dateStr >= booking.checkin && dateStr < booking.checkout) {
          bookingIndex = index;
        }
      });

      if (bookingIndex >= 0) {
        dayDiv.classList.add(
          bookingIndex % 2 === 0 ? "booked-light" : "booked-dark"
        );
      } else {
        dayDiv.classList.add("free");
      }
    }

    calendar.appendChild(dayDiv);
  }

  monthDiv.appendChild(calendar);
  container.appendChild(monthDiv);
}

/* ===================== EXISTING FUNCTIONS (UNCHANGED) ===================== */

/* Commission + Welcome code remains exactly as your original */

</script>

  <script>
function loadUpcomingGuests() {

  document.getElementById("adminMenu").style.display = "none";
  document.getElementById("calendarSection").style.display = "none";
  document.getElementById("guestSection").style.display = "block";

  fetch(API_URL + "?action=get_upcoming_guests")
  .then(res => res.json())
  .then(response => {

    const guests = response.data || [];

    if (guests.length === 0) {
      document.getElementById("guestTable").innerHTML =
        "<p>No upcoming guests.</p>";
      return;
    }

    let html = `
      <table>
        <tr>
          <th>Name</th>
          <th>Booking ID</th>
          <th>From</th>
          <th>To</th>
          <th>Mobile</th>
          <th>Email</th>
          <th>Days</th>
          <th>Payment Status</th>
          <th>Coupon</th>
        </tr>
    `;

    guests.forEach((g, index) => {

      html += `
        <tr>
          <td>${g.name}</td>
          <td>
            <a href="#" onclick="toggleDetails(${index}); return false;">
              ${g.bookingId}
            </a>
          </td>
          <td>${g.fromDate}</td>
          <td>${g.toDate}</td>
          <td>${g.mobile}</td>
          <td>${g.email}</td>
          <td>${g.days}</td>
          <td>${g.paymentStatus}</td>
          <td>${g.couponCode || "-"}</td>
        </tr>

        <tr id="details-${index}" style="display:none; background:#f9f9f9;">
          <td colspan="9">
            <strong>Base:</strong> â‚¹${g.baseAmount} |
            <strong>Discount:</strong> â‚¹${g.discount} |
            <strong>Net:</strong> â‚¹${g.netAmount} |
            <strong>Advance Required:</strong> â‚¹${g.advanceRequired} |
            <strong>Paid So Far:</strong> â‚¹${g.paidSoFar} |
            <strong>Balance:</strong> â‚¹${g.balanceAmount}
          </td>
        </tr>
      `;
    });

    html += "</table>";

    document.getElementById("guestTable").innerHTML = html;
  });
}

function toggleDetails(index) {

  const row = document.getElementById("details-" + index);

  if (row.style.display === "none") {
    row.style.display = "table-row";
  } else {
    row.style.display = "none";
  }
}
</script>  

<script>
function loadReferralPartners() {

  document.getElementById("adminMenu").style.display = "none";
  document.getElementById("calendarSection").style.display = "none";
  document.getElementById("guestSection").style.display = "none";
  document.getElementById("referralSection").style.display = "block";

  fetch(API_URL + "?action=get_referral_partners")
  .then(res => res.json())
  .then(response => {

    const partners = response.data || [];

    let html = `
      <table>
        <tr>
          <th>Name</th>
          <th>Mobile</th>
          <th>Email</th>
          <th>Coupon Code</th>
        </tr>
    `;

    partners.forEach(p => {
      html += `
        <tr>
          <td>${p.name}</td>
          <td>${p.mobile}</td>
          <td>${p.email}</td>
          <td>
            <a href="#" onclick="loadReferralCommissions('${p.mobile}'); return false;">
              ${p.coupon}
            </a>
          </td>
        </tr>
      `;
    });

    html += "</table>";

    document.getElementById("referralTable").innerHTML = html;
    document.getElementById("referralCommissionDetails").innerHTML = "";

  });
}
</script>  

<script>
function loadReferralCommissions(mobile) {

  fetch(API_URL + "?action=get_referral_commissions&mobile=" + mobile)
  .then(res => res.json())
  .then(response => {

    const data = response.data;

    if (!data || !data.commissions.length) {
      document.getElementById("referralCommissionDetails").innerHTML =
        "<p>No commission records found.</p>";
      return;
    }

    let html = `
      <h4>Commission Details</h4>
      <table>
        <tr>
          <th>Booking ID</th>
          <th>Guest Name</th>
          <th>Days</th>
          <th>Total Commission</th>
          <th>Status</th>
          <th>Paid Date</th>
        </tr>
    `;

    data.commissions.forEach(c => {
      html += `
        <tr>
          <td>${c.bookingId}</td>
          <td>${c.guestName}</td>
          <td>${c.days}</td>
          <td>â‚¹${c.totalCommission}</td>
          <td>${c.commissionStatus}</td>
          <td>${c.commissionPaidDate || "-"}</td>
        </tr>
      `;
    });

    html += `
      </table>
      <br>
      <strong>Total Paid:</strong> â‚¹${data.totalPaid}
      <br>
      <strong>Total Pending:</strong> â‚¹${data.totalPending}
    `;

    document.getElementById("referralCommissionDetails").innerHTML = html;
  });
}

  
</script>  


  
<script src="script.js"></script>

</body>
</html>
