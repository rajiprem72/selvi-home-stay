<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Complete Payment — Selvi Home Stay</title>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<link rel="stylesheet" href="https://selvi-home-stay.in/style.css">

<style>
.summary {
  background:#f9fafb;
  padding:20px;
  border-radius:12px;
  margin:20px 0;
}
.amount {
  font-size:20px;
  font-weight:bold;
}
button {
  margin:10px 5px 0 0;
}
.notice {
  margin-top:20px;
  padding:12px;
  border-radius:8px;
}
.notice-error {
  background:#fef2f2;
  color:#7f1d1d;
}
</style>
</head>

<body>
<div class="container">

<h2>Complete Your Booking Payment</h2>

<div id="content"></div>

</div>

<script>

const APPS_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbxJJUirnar3OBGwszagDNWH_Js0FhYfzKMYyRVl06bH4IOseYcZ3vIRr6izAHERWqko/exec";

const urlParams = new URLSearchParams(window.location.search);
const bookingId = urlParams.get("bookingId");

if (!bookingId) {
  document.getElementById("content").innerHTML =
    "<div class='notice notice-error'>Invalid payment link.</div>";
} else {
  loadBooking();
}

async function loadBooking() {

  const res = await fetch(
    APPS_SCRIPT_URL + "?action=get_booking_details&bookingId=" + bookingId
  );

  const data = await res.json();

  if (!data.success) {
    document.getElementById("content").innerHTML =
      "<div class='notice notice-error'>" + data.error + "</div>";
    return;
  }

  renderBooking(data);
}

function renderBooking(data) {

  function formatDate(dateStr) {
  if (!dateStr) return "-";

  const d = new Date(dateStr);
  if (isNaN(d)) return "-";

  return d.toLocaleDateString("en-IN", {
    weekday: "long",
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

  const html = `
  <div class="summary">
    <p><strong>Booking ID:</strong> ${data.bookingId}</p>
    <p><strong>Name:</strong> ${data.name}</p>
    <p><strong>From Date:</strong> ${formatDate(data.fromDate)}</p>
    <p><strong>To Date:</strong> ${formatDate(data.toDate)}</p>
    <p><strong>Days:</strong> ${data.days}</p>
    <p><strong>Total Amount:</strong> ₹${data.baseAmount}</p>
    <p><strong>Discount:</strong> ₹${data.discount}</p>
    <p class="amount">Net Payable: ₹${data.netAmount}</p>
    <p><strong>Advance Required:</strong> ₹${data.advanceRequired}</p>
    <p><strong>Paid So Far:</strong> ₹${data.paidSoFar}</p>
    <p><strong>Balance:</strong> ₹${data.balance}</p>
  </div>

  <button onclick="pay('full')">
    Pay Balance Amount
  </button>
  `;

  document.getElementById("content").innerHTML = html;
}


//rzp_test_SFC8RWThE195Ua  
async function pay(type) {

  const res = await fetch(APPS_SCRIPT_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "create_razorpay_order",
      bookingId: bookingId,
      paymentType: type
    })
  });

  const order = await res.json();

  if (!order.id) {
    alert("Order creation failed");
    console.log(order);
    return;
  }

  const options = {
    key: "rzp_test_SFC8RWThE195Ua",  // only KEY ID here
    amount: order.amount,
    currency: "INR",
    name: "Selvi Home Stay",
    description: "Booking Payment",
    order_id: order.id,

    handler: function (response) {
      alert("Payment Successful\nPayment ID: " + response.razorpay_payment_id);
    }
  };

  const rzp = new Razorpay(options);
  rzp.open();
}

</script>

</body>
</html>
